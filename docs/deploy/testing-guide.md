# メールリンク認証テストガイド

## テスト環境の準備

### 1. ローカル環境でのテスト

```bash
# 開発サーバー起動
pnpm -w dev

# ブラウザで http://localhost:3000 にアクセス
```

### 2. 本番環境でのテスト

- Vercelデプロイ完了後、本番URLでテスト
- 環境変数が正しく設定されていることを確認

## テストケース

### ケース1: 新規ユーザー登録

#### 手順
1. `/auth/login` にアクセス
2. **「新規作成」** タブを選択
3. ユーザー名を入力（例: `testuser`）
4. メールアドレスを入力（例: `test@example.com`）
5. **「リンクを送信」** をクリック

#### 期待結果
- 「送信完了」メッセージが表示される
- 入力したメールアドレスが表示される
- メールが受信される

#### 確認項目
- [ ] フォームバリデーションが正常に動作
- [ ] エラーメッセージが適切に表示
- [ ] メール送信が成功
- [ ] 送信完了画面が表示

### ケース2: メールリンクでの認証完了

#### 手順
1. 受信したメール内のリンクをクリック
2. `/auth/complete` にリダイレクトされる
3. 認証処理が実行される
4. `/home` にリダイレクトされる

#### 期待結果
- 認証が正常に完了する
- ユーザー情報がFirestoreに保存される
- ホーム画面にリダイレクトされる

#### 確認項目
- [ ] 認証完了メッセージが表示
- [ ] Firestoreに `profiles/{uid}` が作成される
- [ ] Firestoreに `usernames/{name}` が作成される
- [ ] ホーム画面に正しくリダイレクト
- [ ] ヘッダーにユーザー名が表示

### ケース3: 既存ユーザーのログイン

#### 手順
1. `/auth/login` にアクセス
2. **「ログイン」** タブを選択
3. 登録済みのメールアドレスを入力
4. **「リンクを送信」** をクリック
5. メール内のリンクで認証

#### 期待結果
- 新規作成時と同様に認証が完了
- 既存のユーザー情報が保持される

#### 確認項目
- [ ] ログインタブが正常に動作
- [ ] 既存ユーザーでの認証が成功
- [ ] ユーザー情報が正しく表示

### ケース4: ホーム画面の3CTA

#### 手順
1. 認証完了後、ホーム画面にアクセス
2. 3つのCTAボタンを確認

#### 期待結果
- CPU対戦、オンライン対戦、フレンド対戦の3つが表示
- 各ボタンが正しいリンクに遷移

#### 確認項目
- [ ] 3つのCTAが正しく表示
- [ ] CPU対戦ボタンが `/play/cucumber5?mode=cpu...` に遷移
- [ ] オンライン対戦ボタンが `/lobby/cucumber5?mode=public` に遷移
- [ ] フレンド対戦ボタンが `/lobby/cucumber5?mode=friends` に遷移

## エラーケースのテスト

### ケース5: 無効なメールアドレス

#### 手順
1. 無効なメールアドレスを入力
2. 送信を試行

#### 期待結果
- 適切なエラーメッセージが表示
- 送信が失敗する

### ケース6: 無効なリンク

#### 手順
1. 無効な認証リンクにアクセス

#### 期待結果
- エラーメッセージが表示
- 適切なフォールバック処理が実行

## パフォーマンステスト

### ケース7: 同時アクセス

#### 手順
1. 複数のブラウザで同時に認証を試行
2. レスポンス時間を測定

#### 確認項目
- [ ] 認証処理が正常に完了
- [ ] レスポンス時間が許容範囲内
- [ ] エラーが発生しない

## セキュリティテスト

### ケース8: 認証状態の確認

#### 手順
1. 認証完了後、ページをリロード
2. 認証状態が保持されることを確認

#### 確認項目
- [ ] 認証状態が正しく保持
- [ ] ユーザー情報が正しく表示
- [ ] 未認証時の適切なリダイレクト

## テスト結果の記録

### テスト結果テンプレート

```
テスト日時: YYYY-MM-DD HH:MM
テスト環境: [ローカル/本番]
テスト者: [名前]

ケース1: 新規ユーザー登録
- 結果: [成功/失敗]
- 備考: [詳細]

ケース2: メールリンクでの認証完了
- 結果: [成功/失敗]
- 備考: [詳細]

... (以下同様)
```

## 問題が発生した場合

### ログの確認

```bash
# ブラウザの開発者ツール
console.log('認証エラー:', error)

# Firebase コンソール
# Authentication > Users でユーザー情報を確認
# Firestore でデータの保存状況を確認
```

### よくある問題と解決方法

1. **メールが届かない**
   - 迷惑メールフォルダを確認
   - Firebase設定を確認

2. **認証エラー**
   - 環境変数の設定を確認
   - Firebase設定を確認

3. **リダイレクトエラー**
   - `NEXT_PUBLIC_APP_ORIGIN` の設定を確認
   - 認証ドメインの設定を確認
